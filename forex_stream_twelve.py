from datetime import datetime
import firebase_admin
import requests
from firebase_admin import credentials
from firebase_admin import db

from lib.fcm import send_notif


def get_volume(pair, multiplier, timespan):
    if timespan == 'h':
        if multiplier == '1':
            if pair == 'AUDUSD':
                return {
                    '1663851600000': 6976,
                    '1663855200000': 7356,
                    '1663858800000': 3944,
                    '1663862400000': 4494,
                    '1663866000000': 2771,
                    '1663869600000': 3064,
                    '1663873200000': 3534,
                    '1663876800000': 931,
                    '1663880400000': 195,
                    '1663884000000': 800,
                    '1663887600000': 1588,
                    '1663891200000': 3072,
                    '1663894800000': 3900,
                    '1663898400000': 3046,
                    '1663902000000': 2684,
                    '1663905600000': 2646,
                    '1663909200000': 3247,
                    '1663912800000': 4419,
                    '1663916400000': 6579,
                    '1663920000000': 4857,
                    '1663923600000': 6165,
                    '1663927200000': 7011,
                    '1663930800000': 7341,
                    '1663934400000': 6485,
                    '1663938000000': 8953,
                    '1663941600000': 9496,
                    '1663945200000': 6257,
                    '1663948800000': 3379,
                    '1663952400000': 4200,
                    '1663956000000': 4965,
                    '1663959600000': 4974,
                    '1663963200000': 1581,
                    '1664139600000': 453,
                    '1664143200000': 2898,
                    '1664146800000': 3874,
                    '1664150400000': 7628,
                    '1664154000000': 13278,
                    '1664157600000': 5876,
                    '1664161200000': 5078,
                    '1664164800000': 5069
                }
            elif pair == 'EURUSD':
                return {
                    '1663851600000': 11603,
                    '1663855200000': 12168,
                    '1663858800000': 7656,
                    '1663862400000': 6521,
                    '1663866000000': 4884,
                    '1663869600000': 3895,
                    '1663873200000': 4627,
                    '1663876800000': 1244,
                    '1663880400000': 1991,
                    '1663884000000': 1401,
                    '1663887600000': 1278,
                    '1663891200000': 2826,
                    '1663894800000': 3238,
                    '1663898400000': 2417,
                    '1663902000000': 1792,
                    '1663905600000': 2086,
                    '1663909200000': 3079,
                    '1663912800000': 5158,
                    '1663916400000': 10695,
                    '1663920000000': 7140,
                    '1663923600000': 9495,
                    '1663927200000': 10994,
                    '1663930800000': 10685,
                    '1663934400000': 8844,
                    '1663938000000': 11160,
                    '1663941600000': 12890,
                    '1663945200000': 8134,
                    '1663948800000': 5727,
                    '1663952400000': 6212,
                    '1663956000000': 7739,
                    '1663959600000': 6927,
                    '1663963200000': 2706,
                    '1664139600000': 606,
                    '1664143200000': 4354,
                    '1664146800000': 4375,
                    '1664150400000': 8670,
                    '1664154000000': 17396,
                    '1664157600000': 6942,
                    '1664161200000': 6422,
                    '1664164800000': 5685
                }
            elif pair == 'GBPUSD':
                return {
                    '1663851600000': 16113,
                    '1663855200000': 16755,
                    '1663858800000': 10213,
                    '1663862400000': 8145,
                    '1663866000000': 6919,
                    '1663869600000': 6249,
                    '1663873200000': 7361,
                    '1663876800000': 1950,
                    '1663880400000': 8595,
                    '1663884000000': 2666,
                    '1663887600000': 2955,
                    '1663891200000': 5160,
                    '1663894800000': 6503,
                    '1663898400000': 4310,
                    '1663902000000': 5016,
                    '1663905600000': 5104,
                    '1663909200000': 7368,
                    '1663912800000': 7809,
                    '1663916400000': 13632,
                    '1663920000000': 11186,
                    '1663923600000': 17368,
                    '1663927200000': 19521,
                    '1663930800000': 17710,
                    '1663934400000': 14277,
                    '1663938000000': 15955,
                    '1663941600000': 20377,
                    '1663945200000': 15644,
                    '1663948800000': 13058,
                    '1663952400000': 11266,
                    '1663956000000': 12906,
                    '1663959600000': 11095,
                    '1663963200000': 4626,
                    '1664139600000': 1539,
                    '1664143200000': 8700,
                    '1664146800000': 8866,
                    '1664150400000': 16021,
                    '1664154000000': 25456,
                    '1664157600000': 18839,
                    '1664161200000': 16011,
                    '1664164800000': 17544
                }
            elif pair == 'USDCAD':
                return {
                    '1663851600000': 10733,
                    '1663855200000': 12524,
                    '1663858800000': 6808,
                    '1663862400000': 7399,
                    '1663866000000': 5870,
                    '1663869600000': 4886,
                    '1663873200000': 6544,
                    '1663876800000': 2184,
                    '1663880400000': 511,
                    '1663884000000': 892,
                    '1663887600000': 1577,
                    '1663891200000': 2955,
                    '1663894800000': 3520,
                    '1663898400000': 3641,
                    '1663902000000': 2491,
                    '1663905600000': 2324,
                    '1663909200000': 2324,
                    '1663912800000': 3044,
                    '1663916400000': 4033,
                    '1663920000000': 8099,
                    '1663923600000': 5183,
                    '1663927200000': 7083,
                    '1663930800000': 7566,
                    '1663934400000': 8759,
                    '1663938000000': 8809,
                    '1663941600000': 11019,
                    '1663945200000': 13758,
                    '1663948800000': 9528,
                    '1663952400000': 6272,
                    '1663956000000': 7265,
                    '1663959600000': 9114,
                    '1663963200000': 3313,
                    '1664139600000': 157,
                    '1664143200000': 3512,
                    '1664146800000': 3850,
                    '1664150400000': 7646,
                    '1664154000000': 13926,
                    '1664157600000': 7215,
                    '1664161200000': 5411,
                    '1664164800000': 5304
                }
            elif pair == 'USDJPY':
                return {
                    '1663851600000': 18510,
                    '1663855200000': 15623,
                    '1663858800000': 10311,
                    '1663862400000': 7865,
                    '1663866000000': 5200,
                    '1663869600000': 4828,
                    '1663873200000': 5055,
                    '1663876800000': 2700,
                    '1663880400000': 6319,
                    '1663884000000': 3045,
                    '1663887600000': 3448,
                    '1663891200000': 6682,
                    '1663894800000': 8106,
                    '1663898400000': 5482,
                    '1663902000000': 5313,
                    '1663905600000': 6010,
                    '1663909200000': 5542,
                    '1663912800000': 8776,
                    '1663916400000': 13659,
                    '1663920000000': 10425,
                    '1663923600000': 15729,
                    '1663927200000': 17069,
                    '1663930800000': 16029,
                    '1663934400000': 13871,
                    '1663938000000': 15633,
                    '1663941600000': 14055,
                    '1663945200000': 9140,
                    '1663948800000': 7080,
                    '1663952400000': 6445,
                    '1663956000000': 5646,
                    '1663959600000': 5655,
                    '1663963200000': 2979,
                    '1664139600000': 232,
                    '1664143200000': 4277,
                    '1664146800000': 6088,
                    '1664150400000': 12185,
                    '1664154000000': 14429,
                    '1664157600000': 7715,
                    '1664161200000': 8530,
                    '1664164800000': 7694
                }
            elif pair == 'XAUUSD':
                return {
                    '1663851600000': 15848,
                    '1663855200000': 14554,
                    '1663858800000': 8736,
                    '1663862400000': 6530,
                    '1663866000000': 4318,
                    '1663869600000': 4220,
                    '1663873200000': 3615,
                    '1663876800000': 1096,
                    '1663880400000': 0,
                    '1663884000000': 752,
                    '1663887600000': 597,
                    '1663891200000': 2021,
                    '1663894800000': 4030,
                    '1663898400000': 2881,
                    '1663902000000': 2410,
                    '1663905600000': 1994,
                    '1663909200000': 3093,
                    '1663912800000': 4374,
                    '1663916400000': 8086,
                    '1663920000000': 5555,
                    '1663923600000': 9891,
                    '1663927200000': 9460,
                    '1663930800000': 12541,
                    '1663934400000': 10967,
                    '1663938000000': 16940,
                    '1663941600000': 12640,
                    '1663945200000': 7460,
                    '1663948800000': 3847,
                    '1663952400000': 3835,
                    '1663956000000': 4592,
                    '1663959600000': 5441,
                    '1663963200000': 2053,
                    '1664139600000': 0,
                    '1664143200000': 2069,
                    '1664146800000': 1591,
                    '1664150400000': 6490,
                    '1664154000000': 15741,
                    '1664157600000': 6188,
                    '1664161200000': 4174,
                    '1664164800000': 4168
                }
            elif pair == 'GBPJPY':
                return {
                    '1663779600000': 7054,
                    '1663783200000': 40537,
                    '1663786800000': 26185,
                    '1663790400000': 7967,
                    '1663794000000': 1985,
                    '1663797600000': 4619,
                    '1663801200000': 6085,
                    '1663804800000': 11601,
                    '1663808400000': 11090,
                    '1663812000000': 12987,
                    '1663815600000': 13254,
                }
            elif pair == 'EURGBP':
                return {
                    '1663779600000': 2791,
                    '1663783200000': 22003,
                    '1663786800000': 11051,
                    '1663790400000': 3112,
                    '1663794000000': 3383,
                    '1663797600000': 3284,
                    '1663801200000': 3215,
                    '1663804800000': 5474,
                    '1663808400000': 4320,
                    '1663812000000': 6370,
                    '1663815600000': 5416,
                }
            elif pair == 'GBPCAD':
                return {
                    '1663779600000': 6510,
                    '1663783200000': 34366,
                    '1663786800000': 20935,
                    '1663790400000': 5208,
                    '1663794000000': 1936,
                    '1663797600000': 3009,
                    '1663801200000': 4276,
                    '1663804800000': 7843,
                    '1663808400000': 8004,
                    '1663812000000': 8568,
                    '1663815600000': 6882,
                }
            elif pair == 'GBPAUD':
                return {
                    '1663779600000': 4253,
                    '1663783200000': 35052,
                    '1663786800000': 21718,
                    '1663790400000': 4745,
                    '1663794000000': 2339,
                    '1663797600000': 2991,
                    '1663801200000': 3945,
                    '1663804800000': 8359,
                    '1663808400000': 8128,
                    '1663812000000': 9400,
                    '1663815600000': 7401,
                }
            elif pair == 'EURJPY':
                return {
                    '1663779600000': 8369,
                    '1663783200000': 33975,
                    '1663786800000': 22474,
                    '1663790400000': 6645,
                    '1663794000000': 5082,
                    '1663797600000': 4288,
                    '1663801200000': 6020,
                    '1663804800000': 10839,
                    '1663808400000': 10638,
                    '1663812000000': 14232,
                    '1663815600000': 13629,
                }
            elif pair == 'AUDCAD':
                return {
                    '1663779600000': 2808,
                    '1663783200000': 25891,
                    '1663786800000': 15623,
                    '1663790400000': 2804,
                    '1663794000000': 558,
                    '1663797600000': 1545,
                    '1663801200000': 1771,
                    '1663804800000': 4771,
                    '1663808400000': 4759,
                    '1663812000000': 5246,
                    '1663815600000': 3591,
                }
            elif pair == 'EURAUD':
                return {
                    '1663779600000': 5732,
                    '1663783200000': 30768,
                    '1663786800000': 23330,
                    '1663790400000': 5568,
                    '1663794000000': 1169,
                    '1663797600000': 3546,
                    '1663801200000': 4380,
                    '1663804800000': 9238,
                    '1663808400000': 9316,
                    '1663812000000': 9226,
                    '1663815600000': 6968,
                }
            elif pair == 'AUDJPY':
                return {
                    '1663779600000': 5215,
                    '1663783200000': 35291,
                    '1663786800000': 24186,
                    '1663790400000': 6607,
                    '1663794000000': 3370,
                    '1663797600000': 2734,
                    '1663801200000': 3831,
                    '1663804800000': 9258,
                    '1663808400000': 9313,
                    '1663812000000': 11525,
                    '1663815600000': 10964,
                }
            elif pair == 'CADJPY':
                return {
                    '1663779600000': 4218,
                    '1663783200000': 29116,
                    '1663786800000': 17902,
                    '1663790400000': 4895,
                    '1663794000000': 1114,
                    '1663797600000': 2039,
                    '1663801200000': 3333,
                    '1663804800000': 6402,
                    '1663808400000': 6565,
                    '1663812000000': 8281,
                    '1663815600000': 7884,
                }
            elif pair == 'EURCAD':
                return {
                    '1663779600000': 3800,
                    '1663783200000': 27709,
                    '1663786800000': 16838,
                    '1663790400000': 4014,
                    '1663794000000': 378,
                    '1663797600000': 2286,
                    '1663801200000': 3122,
                    '1663804800000': 5017,
                    '1663808400000': 5694,
                    '1663812000000': 6509,
                    '1663815600000': 4664,
                }


if __name__ == '__main__':
    reference = '/' + 'XAUUSD' + '_' + '1' + 'hour'
    currency = 'XAU/USD'
    multiplier = '1'
    # min, h, day, week, month
    timespan = 'h'
    # My Timezone is +7 and API Timezone is +9 so the different is +2
    timezone = 2 * 3600000
    start_time = int(datetime.strptime('2022-09-22 20:00:00', '%Y-%m-%d %H:%M:%S').timestamp() * 1000) + timezone
    end_time = int(datetime.strptime('2022-09-26 12:00:00', '%Y-%m-%d %H:%M:%S').timestamp() * 1000) + timezone
    # use this if daily
    # start_date = '2022-09-01'
    # end_date = '2022-09-12'
    apikey = 'e120fbaf7bf44c358a6b228edbbc62f4'

    url = 'https://api.twelvedata.com/time_series?symbol=' + currency + '&interval=' + multiplier + timespan + \
          '&outputsize=50&apikey=' + apikey

    response = requests.get(url).json()

    json_file = response['values']

    cred = credentials.Certificate("key/firebase_admin.json")
    firebase_admin.initialize_app(cred, {
        'databaseURL': 'https://forex-bd746-default-rtdb.asia-southeast1.firebasedatabase.app/'
    })
    ref = db.reference(reference)

    currency = currency.replace('/','')
    volume = get_volume(currency, multiplier, timespan)
    dataForex = {}
    for i in json_file:
        current_time = int(datetime.strptime(i['datetime'], '%Y-%m-%d %H:%M:%S').timestamp() * 1000)
        if start_time < current_time <= end_time:
            current_time = (current_time - timezone) - 3600000
            data = {
                'o': float(i['open']),
                'h': float(i['high']),
                'l': float(i['low']),
                'c': float(i['close']),
                'v': volume.get(str(current_time))
            }
            # ref.child(str(current_time)).set(data)
            print(str(current_time) + ': ' + str(data))

